#include <stdio.h>
#include <stdlib.h>

// NB: tested on debian wheezy amd64

#define BUFSIZE   104
#define RBPOFFSET   8   // YMMV
#define RIPOFFSET  16   // YMMV

/*
  echo (gets & printf) each line on stdin until EOF or empty line;
  INSECURE!
*/
void handler()
{
  char buf[BUFSIZE];

  if (getenv("DEBUG")) {
    fprintf(stderr, "handler() {\n");
    fprintf(stderr, "&buf[0]: %p\n", &buf[0]);
    fprintf(stderr, "   &rbp: %p\n", &buf[0] + BUFSIZE + RBPOFFSET);
    fprintf(stderr, "   &rip: %p\n", &buf[0] + BUFSIZE + RIPOFFSET);
    fprintf(stderr, "    rbp: %p\n", *(void**)(&buf[0] + BUFSIZE + RBPOFFSET));
    fprintf(stderr, "    rip: %p\n", *(void**)(&buf[0] + BUFSIZE + RIPOFFSET));
    fprintf(stderr, "\n");
  }

  while (!feof(stdin)) {
    gets(buf);    // buffer overflow
    if (buf[0] == '\0') break;
    printf(buf);  // uncontrolled format string
    printf("\n");
    fflush(stdout);
  }

  if (getenv("DEBUG")) {
    fprintf(stderr, "\n");
    fprintf(stderr, "    rbp: %p\n", *(void**)(&buf[0] + BUFSIZE + RBPOFFSET));
    fprintf(stderr, "    rip: %p\n", *(void**)(&buf[0] + BUFSIZE + RIPOFFSET));
    fprintf(stderr, "}\n");
  }
}

/*
  call handler()
*/
int main()
{
  handler();
  return 0;
}
